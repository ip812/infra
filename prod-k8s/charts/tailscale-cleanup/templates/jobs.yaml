---
apiVersion: v1
kind: Secret
metadata:
  name: "tailscale-cleanup-creds"
type: Opaque
stringData:
  ts-api-key: "{{ .Values.tsApiKey }}"
  tailnet: "{{ .Values.tailnet }}"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: remove-stale-devices
spec:
  parallelism: 1
  completions: 1
  activeDeadlineSeconds: 100
  backoffLimit: 1
  template:
    spec:
      containers:
        - name: remove-stale-devices
          image: badouralix/curl-jq
          command: ["/bin/sh", "-c"]
          args:
            args:
          - |
            echo "Using Tailscale API key: $TAILSCALE_API_KEY"
            echo "Using tailnet: $TAILNET"
            NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            echo "Current time in UTC: $NOW"
            DEVICES=$(curl -s -H "Authorization: Bearer $TAILSCALE_API_KEY" "https://api.tailscale.com/api/v2/tailnet/$TAILNET/devices")
            echo "API response: $DEVICES"
            echo "$DEVICES" | jq -r '.devices[] | "\(.id) \(.lastSeen)"' > /tmp/devices.txt
            echo "JQ output written to /tmp/devices.txt"
            cat /tmp/devices.txt
            while read DEVICE_ID LAST_SEEN; do
                echo "Processing device $DEVICE_ID, last seen at $LAST_SEEN"
                if [ -n "$LAST_SEEN" ] && [ "$LAST_SEEN" \< "$NOW" ]; then
                    echo "Device $DEVICE_ID has not been seen since $LAST_SEEN, removing..."
                    curl -s -X DELETE -H "Authorization: Bearer $TAILSCALE_API_KEY" "https://api.tailscale.com/api/v2/device/$DEVICE_ID"
                else
                    echo "Device $DEVICE_ID is either recent or has no lastSeen, skipping..."
                fi
            done < /tmp/devices.txt
          env:
            - name: TAILSCALE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: tailscale-cleanup-creds
                  key: ts-api-key
            - name: TAILNET
              valueFrom:
                secretKeyRef:
                  name: tailscale-cleanup-creds
                  key: tailnet
      restartPolicy: Never

---
apiVersion: v1
kind: Secret
metadata:
  name: "tailscale-cleanup-creds"
type: Opaque
stringData:
  ts-api-key: "{{ .Values.tsApiKey }}"
  tailnet: "{{ .Values.tailnet }}"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: remove-stale-devices
spec:
  parallelism: 1
  completions: 1
  activeDeadlineSeconds: 100
  backoffLimit: 1
  template:
    spec:
      containers:
        - name: remove-stale-devices
          image: badouralix/curl-jq
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Using tailnet: $TAILNET"
              echo "Using API key: ${TAILSCALE_API_KEY:0:4}****"
              echo "Details:"
              curl -s -H "Authorization: Bearer $TAILSCALE_API_KEY" "https://api.tailscale.com/api/v2/tailnet/$TAILNET/devices"
              NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              echo "Current time in UTC: $NOW"
              curl -s -H "Authorization: Bearer $TAILSCALE_API_KEY" "https://api.tailscale.com/api/v2/tailnet/$TAILNET/devices" \
              | jq -r '.devices[] | "\(.id) \(.lastSeen)"' \
              | while read DEVICE_ID LAST_SEEN; do
                  echo "Checking device $DEVICE_ID, last seen at $LAST_SEEN"
                  if [ "$LAST_SEEN" \< "$NOW" ]; then
                      echo "Device $DEVICE_ID has not been seen since $LAST_SEEN, removing..."
                      curl -s -X DELETE -H "Authorization: Bearer $TAILSCALE_API_KEY" "https://api.tailscale.com/api/v2/device/$DEVICE_ID"
                  fi
                done
          env:
            - name: TAILSCALE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: tailscale-cleanup-creds
                  key: ts-api-key
            - name: TAILNET
              valueFrom:
                secretKeyRef:
                  name: tailscale-cleanup-creds
                  key: tailnet
      restartPolicy: Never
